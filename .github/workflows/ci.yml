  name: Pull Request

  on:
    pull_request:
      branches:
        - master
        - release**
        - develop 
        - main 

  jobs:
    static-code-analysis-and-integration-test:
      runs-on: macos-latest
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      steps:    
        - name: Checkout code
          uses: actions/checkout@v1

        - name: Setup SSH
          id: Setup-SSH
          run: |
            mkdir -p ~/.ssh
            echo "${{ secrets.ACTIONS_DEPLOY_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan github.com >> ~/.ssh/known_hosts

        - name: Set up Flutter
          id: Setup-flutter
          uses: subosito/flutter-action@v2 
          with:
            flutter-version: '3.22.0'

        - name: Install dependencies
          id: Install-dependencies
          run: flutter pub get

        # - name: Static code analysis
        #   id: static-code-analysis
        #   run: |
        #     flutter --version
        #     dart --version
        #     flutter analyze

        - name: Integration test
          if: ${{ github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'master' || github.base_ref == 'develop') }}
          id: Integration-test
          run: |
            flutter drive --driver=test_driver/integration_test.dart --target=test/sauna_session_test.dart --flavor=red --dart-define=flavor=red -d web-server --release --browser-name=safari

        - name: Notify Slack 
          uses: act10ns/slack@v2     
          with:
            channel: 's1-panel'
            status: ${{ job.status }}
            steps: ${{ toJson(steps) }}
          if: always()
