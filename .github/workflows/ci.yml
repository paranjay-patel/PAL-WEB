name: Pull Request

on:
  pull_request:
    branches:
      - master
      - main
      - develop
      - release/**

jobs:
  Run-Linter:
    runs-on: ubuntu-latest
    permissions: write-all
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
    - name: notify slack      
      uses: act10ns/slack@v2
      with:
        channel: 's1-panel'
        status: starting
        steps: ${{ toJson(steps) }}
      if: always()
      
    - name: Checkout code
      id: Checkout-code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Java
      id : Install-java
      uses: actions/setup-java@v1
      with:
        java-version: '19.0.1'

    - name: Set up Flutter
      id: Setup-flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2' 

    - name: Install dependencies
      id: Install-dependencies
      run: flutter pub get

    - name: Run linter
      id: Run-linter
      run: |
        flutter --version
        dart --version
        flutter analyze

    - name: notify slack      
      uses: act10ns/slack@v2
      with:
        channel: 's1-panel'
        status: ${{ job.status }}
        steps: ${{ toJson(steps) }}
      if: always()

  Sonar-Scanner:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Notify Slack
        uses: act10ns/slack@v2
        with:
          channel: s1-panel
          status: starting
          steps: ${{ toJson(steps) }}
        if: always()
      
      - name: Checkout code
        id: Checkout-code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Setup SSH
        id: Setup-SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ACTIONS_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Set up Flutter
        id: Setup-flutter
        uses: subosito/flutter-action@v2  
        with:
          flutter-version: '3.22.0'

      - name: Install dependencies
        id: Install-dependencies
        run: flutter pub get
     
      - name: Sonar scanner
        id: Sonar-scan
        env:
          SONAR_SCANNER_VER: sonar-scanner-cli-4.7.0.2747-linux
          SONAR_SCANNER_PATH: sonar-scanner-4.7.0.2747-linux/bin
        run: |
          wget --quiet https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
          unzip -q sonar-scanner-cli-4.7.0.2747-linux.zip
          $SONAR_SCANNER_PATH/sonar-scanner -v
          $SONAR_SCANNER_PATH/sonar-scanner -Dsonar.login=${{ secrets.SONAR_TOKEN }} -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}

      - name: Quality gate check
        id: Quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Notify Slack
        uses: act10ns/slack@v2
        with:
          channel: s1-panel
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
        if: always()
