name: Validate PR

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up GitHub CLI
        uses: dawidd6/action-install-gh-cli@v1

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get PR details
        id: pr_details
        run: |
          echo "PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV
          echo "PR_TITLE=$(jq --raw-output .pull_request.title "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV
          echo "PR_DESCRIPTION=$(jq --raw-output .pull_request.body "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV
          echo "REPO_FULL_NAME=$(jq --raw-output .repository.full_name "$GITHUB_EVENT_PATH")" >> $GITHUB_ENV

      - name: Log PR details
        run: |
          echo "PR Number: $PR_NUMBER"
          echo "PR Title: $PR_TITLE"
          echo "Repository: $REPO_FULL_NAME"
          echo "PR Description: $PR_DESCRIPTION"

      - name: Check JIRA Ticket Reference
        run: .github/scripts/check_jira_ticket.sh "$PR_TITLE"

      - name: Check Commits Signed
        run: .github/scripts/check_commits_signed.sh "$PR_NUMBER" "$REPO_FULL_NAME"

      - name: Check PR Description
        run: .github/scripts/check_pr_description.sh "$PR_DESCRIPTION" "$jira_ticket"
        env:
          jira_ticket: $(echo "$PR_TITLE" | awk '{print toupper($0)}' | cut -d: -f1)
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
